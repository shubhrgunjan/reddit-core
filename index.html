import React, { useState, useEffect, useCallback } from 'react';
import { 
  Search, 
  MessageSquare, 
  User, 
  Hash, 
  Calendar, 
  SortAsc, 
  ExternalLink, 
  ArrowUpCircle, 
  Clock, 
  Maximize2,
  ChevronDown,
  Moon,
  Sun,
  LayoutGrid,
  List,
  CheckCircle2,
  AlertCircle,
  RefreshCw,
  X,
  Globe,
  PlusCircle,
  Database,
  Check
} from 'lucide-react';

// Firebase Imports
import { initializeApp } from 'firebase/app';
import { getAuth, onAuthStateChanged, signInWithCustomToken, signInAnonymously } from 'firebase/auth';
import { getFirestore, doc, setDoc, collection, serverTimestamp } from 'firebase/firestore';

// --- Updated Firebase Configuration (Quora CMS) ---
const firebaseConfig = {
  apiKey: "AIzaSyA6sUTI5E8arl4Pw1dD9XZn6gK396rt3FA",
  authDomain: "quoracms.firebaseapp.com",
  projectId: "quoracms",
  storageBucket: "quoracms.firebasestorage.app",
  messagingSenderId: "111684245151",
  appId: "1:111684245151:web:0cd55819db9d01cc1434aa",
  measurementId: "G-29JSMWD2JZ"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const CMS_APP_ID = 'quora-cms'; // Hardcoded CMS App ID

// API Configuration
const API_BASE_URL = 'https://api.pullpush.io/reddit/search';

const SearchInput = ({ label, icon: Icon, value, onChange, placeholder, type = "text" }) => (
  <div className="flex flex-col gap-1.5 w-full">
    <label className="text-[11px] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider px-1">
      {label}
    </label>
    <div className="relative group">
      <div className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-blue-500 transition-colors">
        <Icon size={14} />
      </div>
      <input 
        type={type}
        value={value}
        onChange={(e) => onChange(e.target.value)}
        placeholder={placeholder}
        className="w-full bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 focus:border-blue-400 dark:focus:border-blue-500 focus:ring-4 focus:ring-blue-50 dark:focus:ring-blue-900/20 rounded-xl py-2 pl-9 pr-4 text-sm outline-none transition-all placeholder:text-slate-300 dark:placeholder:text-slate-600 dark:text-slate-200"
      />
    </div>
  </div>
);

const FilterToggle = ({ label, active, onClick }) => (
  <button 
    onClick={onClick}
    className={`flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${
      active 
        ? 'bg-blue-600 text-white shadow-md shadow-blue-100 dark:shadow-none' 
        : 'bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700'
    }`}
  >
    {active && <CheckCircle2 size={12} />}
    {label}
  </button>
);

const PostCard = ({ post, onSave, isSaving, isSaved }) => {
  const [imageLoaded, setImageLoaded] = useState(false);
  const dateStr = new Date(post.created_utc * 1000).toLocaleString();
  
  const getImageUrl = (item) => {
    if (item.preview?.images?.[0]?.resolutions?.length > 0) {
      const resolutions = item.preview.images[0].resolutions;
      const optimal = resolutions.reduce((prev, curr) => {
        return (Math.abs(curr.width - 640) < Math.abs(prev.width - 640) ? curr : prev);
      });
      return optimal.url.replaceAll('&amp;', '&');
    }
    if (item.preview?.images?.[0]?.source?.url) {
      return item.preview.images[0].source.url.replaceAll('&amp;', '&');
    }
    if (item.url && typeof item.url === 'string' && item.url.match(/\.(jpeg|jpg|gif|png)$/)) {
      return item.url;
    }
    if (item.thumbnail && typeof item.thumbnail === 'string' && item.thumbnail.startsWith('http')) {
      return item.thumbnail;
    }
    return null;
  };

  const imageUrl = getImageUrl(post);

  const renderContent = (content) => {
    if (content === null || content === undefined) return "";
    if (typeof content === 'string') return content;
    return String(content);
  };

  return (
    <div className="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl overflow-hidden hover:shadow-xl hover:shadow-slate-200/50 dark:hover:shadow-black/40 transition-all duration-500 group flex flex-col h-full transform hover:-translate-y-1">
      {imageUrl && (
        <div className="relative aspect-video overflow-hidden bg-slate-100 dark:bg-slate-800 border-b border-slate-100 dark:border-slate-800">
          {!imageLoaded && (
            <div className="absolute inset-0 bg-slate-200 dark:bg-slate-800 animate-pulse flex items-center justify-center">
              <RefreshCw className="text-slate-400 dark:text-slate-600 animate-spin" size={24} />
            </div>
          )}
          <img 
            src={imageUrl} 
            alt=""
            onLoad={() => setImageLoaded(true)}
            className={`w-full h-full object-cover transition-all duration-700 ${imageLoaded ? 'opacity-100 scale-100' : 'opacity-0 scale-105'} group-hover:scale-110`}
            loading="lazy"
            onError={(e) => e.target.style.display = 'none'}
          />
          <div className="absolute top-3 left-3">
            <span className="px-2 py-1 bg-black/60 backdrop-blur-md text-white text-[10px] font-bold rounded-md uppercase tracking-wider border border-white/10">
              r/{renderContent(post.subreddit)}
            </span>
          </div>
        </div>
      )}

      <div className="p-5 flex flex-col flex-grow">
        <div className="flex items-center gap-2 text-[10px] font-bold text-slate-400 dark:text-slate-500 mb-2">
          <User size={10} />
          <span className="truncate max-w-[120px]">u/{renderContent(post.author)}</span>
          <span>â€¢</span>
          <Clock size={10} />
          <span>{dateStr}</span>
        </div>

        <h3 className="text-md font-bold text-slate-900 dark:text-slate-100 leading-tight mb-3 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors line-clamp-2">
          {renderContent(post.title) || renderContent(post.body)?.substring(0, 100) + '...'}
        </h3>

        {(post.selftext || post.body) && (
          <p className="text-slate-500 dark:text-slate-400 text-xs line-clamp-3 mb-4 leading-relaxed italic">
            {renderContent(post.selftext || post.body)}
          </p>
        )}

        <div className="mt-auto pt-4 border-t border-slate-50 dark:border-slate-800/50 flex items-center justify-between">
          <div className="flex items-center gap-2">
            <div className="flex items-center gap-1 text-orange-600 dark:text-orange-500 font-bold text-xs bg-orange-50 dark:bg-orange-900/20 px-2 py-1 rounded-lg">
              <ArrowUpCircle size={14} />
              {post.score?.toLocaleString() || 0}
            </div>
            
            <button 
              onClick={() => onSave(post)}
              disabled={isSaving || isSaved}
              className={`flex items-center gap-1.5 px-3 py-1 rounded-lg text-[10px] font-bold transition-all ${
                isSaved 
                  ? 'bg-green-50 dark:bg-green-900/20 text-green-600 dark:text-green-400' 
                  : 'bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 hover:bg-blue-100 dark:hover:bg-blue-900/40'
              }`}
            >
              {isSaving ? (
                <RefreshCw size={12} className="animate-spin" />
              ) : isSaved ? (
                <Check size={12} />
              ) : (
                <Database size={12} />
              )}
              {isSaving ? 'Saving...' : isSaved ? 'In CMS' : 'Add to CMS'}
            </button>
          </div>
          <a 
            href={`https://reddit.com${renderContent(post.permalink)}`} 
            target="_blank" 
            rel="noopener noreferrer"
            className="p-2 text-slate-400 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded-xl transition-all"
          >
            <ExternalLink size={16} />
          </a>
        </div>
      </div>
    </div>
  );
};

export default function App() {
  const [darkMode, setDarkMode] = useState(false);
  const [user, setUser] = useState(null);
  const [query, setQuery] = useState('');
  const [username, setUsername] = useState('');
  const [subreddit, setSubreddit] = useState('');
  const [searchBy, setSearchBy] = useState('both');
  const [searchFor, setSearchFor] = useState('submission');
  const [sortBy, setSortBy] = useState('score');
  const [sortOrder, setSortOrder] = useState('desc');
  const [afterDate, setAfterDate] = useState('2010-01-01');
  const [beforeDate, setBeforeDate] = useState(new Date().toISOString().split('T')[0]);
  const [afterTime, setAfterTime] = useState('00:00');
  const [beforeTime, setBeforeTime] = useState('23:59');
  const [enableAfter, setEnableAfter] = useState(true);
  const [enableBefore, setEnableBefore] = useState(true);
  const [timezone, setTimezone] = useState('Calcutta');
  const [scoreValue, setScoreValue] = useState('0');
  const [scoreOperator, setScoreOperator] = useState('>');
  const [ids, setIds] = useState('');
  const [highlight, setHighlight] = useState(false);
  
  const [results, setResults] = useState([]);
  const [isSearching, setIsSearching] = useState(false);
  const [error, setError] = useState(null);
  const [viewMode, setViewMode] = useState('grid');
  
  // Tracking saves
  const [savingIds, setSavingIds] = useState(new Set());
  const [savedIds, setSavedIds] = useState(new Set());

  // Firebase Auth Setup (RULE 3)
  useEffect(() => {
    const initAuth = async () => {
      try {
        // Since we are using manual quoracms credentials, we sign in anonymously 
        // to that specific project to avoid cross-app custom token mismatches.
        await signInAnonymously(auth);
      } catch (err) {
        console.error("Auth failed:", err);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  const executeSearch = useCallback(async (retryCount = 0) => {
    setIsSearching(true);
    setError(null);

    const type = searchFor === 'submission' ? 'submission' : 'comment';
    const params = new URLSearchParams({
      size: '50',
      sort: sortOrder,
      sort_type: sortBy,
    });

    if (query) params.append('q', query);
    if (subreddit) params.append('subreddit', subreddit);
    if (username) params.append('author', username);
    if (ids) params.append('ids', ids);
    
    if (enableAfter) {
      const dt = new Date(`${afterDate}T${afterTime}:00`);
      params.append('after', Math.floor(dt.getTime() / 1000));
    }
    if (enableBefore) {
      const dt = new Date(`${beforeDate}T${beforeTime}:00`);
      params.append('before', Math.floor(dt.getTime() / 1000));
    }

    if (scoreValue !== '0') {
      params.append('score', `${scoreOperator}${scoreValue}`);
    }

    try {
      const response = await fetch(`${API_BASE_URL}/${type}/?${params.toString()}`);
      if (!response.ok) throw new Error(`API Error: ${response.status}`);
      const json = await response.json();
      setResults(json.data || []);
      setIsSearching(false);
    } catch (err) {
      if (retryCount < 3) {
        const delay = Math.pow(2, retryCount) * 1000;
        setTimeout(() => executeSearch(retryCount + 1), delay);
      } else {
        setError("Failed to fetch data. PullPush might be rate-limiting.");
        setIsSearching(false);
      }
    }
  }, [query, username, subreddit, searchFor, sortBy, sortOrder, afterDate, beforeDate, afterTime, beforeTime, enableAfter, enableBefore, scoreValue, scoreOperator, ids]);

  // Save to CMS Function (RULE 1 - Using your quora-cms public path)
  const saveToCMS = async (post) => {
    if (!user) {
      setError("Please wait for authentication to complete.");
      return;
    }

    const postId = post.id;
    setSavingIds(prev => new Set(prev).add(postId));

    try {
      // Path: /artifacts/quora-cms/public/data/content/{postId}
      const postRef = doc(db, 'artifacts', CMS_APP_ID, 'public', 'data', 'content', postId);
      
      // Sanitizing content to ensure no nested objects cause React issues
      const sanitizedPost = JSON.parse(JSON.stringify(post));

      await setDoc(postRef, {
        ...sanitizedPost,
        saved_at: serverTimestamp(),
        source: 'PullPush Dashboard'
      });

      setSavedIds(prev => new Set(prev).add(postId));
    } catch (err) {
      console.error("Save failed:", err);
      setError("Failed to save to CMS. Check Firestore rules or connection.");
    } finally {
      setSavingIds(prev => {
        const next = new Set(prev);
        next.delete(postId);
        return next;
      });
    }
  };

  const resetFilters = () => {
    setQuery('');
    setUsername('');
    setSubreddit('');
    setScoreValue('0');
    setIds('');
    setHighlight(false);
  };

  return (
    <div className={`${darkMode ? 'dark' : ''}`}>
      <div className="min-h-screen bg-[#FDFDFD] dark:bg-slate-950 text-slate-900 dark:text-slate-100 font-sans selection:bg-blue-100 dark:selection:bg-blue-900/30 transition-colors duration-500">
        
        {/* Header */}
        <nav className="sticky top-0 z-50 bg-white/70 dark:bg-slate-950/70 backdrop-blur-xl border-b border-slate-100 dark:border-slate-800 px-6 py-3 flex items-center justify-between transition-all duration-500">
          <div className="flex items-center gap-3 group cursor-default">
            <div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white shadow-lg shadow-blue-500/20 group-hover:scale-110 transition-transform">
              <Hash size={18} />
            </div>
            <span className="text-lg font-black tracking-tight">PullPush<span className="text-blue-600">.</span>io</span>
          </div>

          <div className="flex items-center gap-3">
            {user && (
              <div className="hidden sm:flex items-center gap-2 px-3 py-1.5 bg-green-50 dark:bg-green-900/20 border border-green-100 dark:border-green-800/50 rounded-xl text-[10px] font-bold text-green-600 dark:text-green-400">
                <div className="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse" />
                CMS Active
              </div>
            )}
            <div className="flex p-1 bg-slate-100 dark:bg-slate-800 rounded-lg mr-4">
               <button onClick={() => setViewMode('grid')} className={`p-1 rounded-md transition-all ${viewMode === 'grid' ? 'bg-white dark:bg-slate-700 shadow-sm text-blue-600 dark:text-blue-400' : 'text-slate-400 hover:text-slate-600 dark:hover:text-slate-200'}`}><LayoutGrid size={16} /></button>
               <button onClick={() => setViewMode('list')} className={`p-1 rounded-md transition-all ${viewMode === 'list' ? 'bg-white dark:bg-slate-700 shadow-sm text-blue-600 dark:text-blue-400' : 'text-slate-400 hover:text-slate-600 dark:hover:text-slate-200'}`}><List size={16} /></button>
            </div>
            <button 
              onClick={() => setDarkMode(!darkMode)}
              className="w-10 h-10 flex items-center justify-center text-slate-400 hover:text-slate-900 dark:hover:text-white hover:bg-slate-50 dark:hover:bg-slate-800 rounded-full transition-all"
            >
              {darkMode ? <Sun size={20} /> : <Moon size={20} />}
            </button>
          </div>
        </nav>

        <div className="max-w-[1600px] mx-auto flex flex-col lg:flex-row">
          
          {/* Sidebar */}
          <aside className="w-full lg:w-[400px] border-r border-slate-100 dark:border-slate-800 p-6 lg:h-[calc(100vh-57px)] lg:sticky lg:top-[57px] overflow-y-auto bg-slate-50/30 dark:bg-slate-900/20 scroll-smooth">
            <div className="flex items-center justify-between mb-6">
              <h2 className="text-sm font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest">Search Control</h2>
              <button onClick={resetFilters} className="text-xs font-bold text-blue-600 dark:text-blue-400 hover:underline">Reset All</button>
            </div>

            <div className="space-y-5">
              <SearchInput label="Keywords" icon={Search} placeholder="Search Term..." value={query} onChange={setQuery} />

              <div className="grid grid-cols-2 gap-4">
                <SearchInput label="Username" icon={User} placeholder="e.g. maxwellhill" value={username} onChange={setUsername} />
                <SearchInput label="Subreddit" icon={Hash} placeholder="e.g. news" value={subreddit} onChange={setSubreddit} />
              </div>

              <div className="space-y-2">
                <label className="text-[11px] font-bold text-slate-400 dark:text-slate-500 uppercase">Search Target</label>
                <div className="flex gap-2">
                  <FilterToggle label="Posts" active={searchFor === 'submission'} onClick={() => setSearchFor('submission')} />
                  <FilterToggle label="Comments" active={searchFor === 'comment'} onClick={() => setSearchFor('comment')} />
                </div>
              </div>

              <div className="space-y-2">
                <label className="text-[11px] font-bold text-slate-400 dark:text-slate-500 uppercase">Search By</label>
                <div className="flex gap-2">
                  <FilterToggle label="Title" active={searchBy === 'title'} onClick={() => setSearchBy('title')} />
                  <FilterToggle label="Body" active={searchBy === 'body'} onClick={() => setSearchBy('body')} />
                  <FilterToggle label="Both" active={searchBy === 'both'} onClick={() => setSearchBy('both')} />
                </div>
              </div>

              <div className="space-y-4 pt-4 border-t border-slate-200 dark:border-slate-800">
                 <div className="flex items-center justify-between">
                    <label className="text-[11px] font-bold text-slate-400 dark:text-slate-500 uppercase flex items-center gap-1"><Calendar size={12}/> Time Constraints</label>
                    <div className="flex items-center gap-1.5 text-[10px] text-blue-600 dark:text-blue-400 font-bold"><Globe size={10}/> {timezone} GMT +05:30</div>
                 </div>

                 <div className="space-y-3">
                    <div className="space-y-2">
                      <div className="flex items-center justify-between px-1">
                        <span className="text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase">After</span>
                        <label className="flex items-center gap-1.5 cursor-pointer">
                          <input type="checkbox" checked={enableAfter} onChange={(e) => setEnableAfter(e.target.checked)} className="rounded dark:bg-slate-800 dark:border-slate-700 text-blue-600" />
                          <span className="text-[10px] font-bold text-slate-400">Enable</span>
                        </label>
                      </div>
                      <div className="grid grid-cols-2 gap-2">
                        <input type="date" value={afterDate} onChange={(e) => setAfterDate(e.target.value)} disabled={!enableAfter} className="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg p-2 text-xs font-semibold outline-none focus:border-blue-400 dark:focus:border-blue-500 disabled:opacity-30 dark:text-slate-200" />
                        <input type="time" value={afterTime} onChange={(e) => setAfterTime(e.target.value)} disabled={!enableAfter} className="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg p-2 text-xs font-semibold outline-none focus:border-blue-400 dark:focus:border-blue-500 disabled:opacity-30 dark:text-slate-200" />
                      </div>
                    </div>

                    <div className="space-y-2">
                      <div className="flex items-center justify-between px-1">
                        <span className="text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase">Before</span>
                        <label className="flex items-center gap-1.5 cursor-pointer">
                          <input type="checkbox" checked={enableBefore} onChange={(e) => setEnableBefore(e.target.checked)} className="rounded dark:bg-slate-800 dark:border-slate-700 text-blue-600" />
                          <span className="text-[10px] font-bold text-slate-400">Enable</span>
                        </label>
                      </div>
                      <div className="grid grid-cols-2 gap-2">
                        <input type="date" value={beforeDate} onChange={(e) => setBeforeDate(e.target.value)} disabled={!enableBefore} className="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg p-2 text-xs font-semibold outline-none focus:border-blue-400 dark:focus:border-blue-500 disabled:opacity-30 dark:text-slate-200" />
                        <input type="time" value={beforeTime} onChange={(e) => setBeforeTime(e.target.value)} disabled={!enableBefore} className="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg p-2 text-xs font-semibold outline-none focus:border-blue-400 dark:focus:border-blue-500 disabled:opacity-30 dark:text-slate-200" />
                      </div>
                    </div>
                 </div>
              </div>

              <div className="pt-4 border-t border-slate-200 dark:border-slate-800 space-y-4">
                 <div className="grid grid-cols-2 gap-4">
                    <div className="space-y-1.5">
                      <label className="text-[11px] font-bold text-slate-400 dark:text-slate-500 uppercase">Score</label>
                      <div className="flex gap-1">
                        <select value={scoreOperator} onChange={(e) => setScoreOperator(e.target.value)} className="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl p-2 text-xs font-bold outline-none dark:text-slate-200">
                          <option value=">">Greater</option>
                          <option value="<">Less</option>
                          <option value="">Equal</option>
                        </select>
                        <input type="number" value={scoreValue} onChange={(e) => setScoreValue(e.target.value)} className="w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl p-2 text-xs font-bold outline-none dark:text-slate-200" />
                      </div>
                    </div>
                    <SearchInput label="IDs" icon={Maximize2} placeholder="Comma separated" value={ids} onChange={setIds} />
                 </div>

                 <div className="flex items-center gap-2 px-1">
                    <input type="checkbox" checked={highlight} onChange={(e) => setHighlight(e.target.checked)} id="highlight" className="rounded dark:bg-slate-800 dark:border-slate-700 text-blue-600" />
                    <label htmlFor="highlight" className="text-xs font-bold text-slate-500 dark:text-slate-400 cursor-pointer">Highlight keywords</label>
                 </div>
              </div>

              <button 
                onClick={() => executeSearch()}
                disabled={isSearching}
                className="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-blue-400/50 text-white font-black py-4 rounded-2xl shadow-xl shadow-blue-500/10 transition-all transform active:scale-[0.98] mt-4 flex items-center justify-center gap-3"
              >
                {isSearching ? <RefreshCw className="animate-spin" size={20} /> : <><Search size={20} /> Execute Search</>}
              </button>
            </div>
          </aside>

          {/* Results Stream */}
          <main className="flex-grow p-6 lg:p-10 bg-white dark:bg-slate-950 min-h-[calc(100vh-57px)] transition-colors duration-500 overflow-y-auto scroll-smooth">
            <div className="mb-8 flex flex-col md:flex-row md:items-end justify-between gap-4">
              <div>
                <h1 className="text-2xl font-black text-slate-900 dark:text-slate-100 tracking-tight">Archive Feed</h1>
                <p className="text-slate-400 dark:text-slate-500 text-sm font-medium">
                  {isSearching ? "Crawling PullPush archives..." : `Found ${results.length} relevant entries`}
                </p>
              </div>
              
              <div className="flex gap-2">
                <select value={sortBy} onChange={(e) => setSortBy(e.target.value)} className="bg-slate-50 dark:bg-slate-900 border border-slate-100 dark:border-slate-800 rounded-xl px-3 py-1.5 text-xs font-bold outline-none dark:text-slate-200">
                  <option value="score">Sort by Score</option>
                  <option value="created_utc">Sort by Date</option>
                  <option value="num_comments">Sort by Comments</option>
                </select>
                <select value={sortOrder} onChange={(e) => setSortOrder(e.target.value)} className="bg-slate-50 dark:bg-slate-900 border border-slate-100 dark:border-slate-800 rounded-xl px-3 py-1.5 text-xs font-bold outline-none dark:text-slate-200">
                  <option value="desc">Descending</option>
                  <option value="asc">Ascending</option>
                </select>
              </div>
            </div>

            {error && (
              <div className="bg-red-50 dark:bg-red-900/10 border border-red-100 dark:border-red-900/30 text-red-600 dark:text-red-400 p-4 rounded-2xl mb-8 flex items-center gap-3 text-sm font-bold animate-in fade-in slide-in-from-top-2 duration-300">
                <AlertCircle size={20} />
                {error}
                <button onClick={() => setError(null)} className="ml-auto hover:bg-red-100 dark:hover:bg-red-900/20 p-1 rounded-lg transition-colors"><X size={16}/></button>
              </div>
            )}

            {isSearching ? (
               <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 opacity-40 grayscale pointer-events-none">
                 {[1,2,3,4,5,6].map(i => <div key={i} className="h-[300px] bg-slate-100 dark:bg-slate-800 rounded-2xl animate-pulse"></div>)}
               </div>
            ) : results.length > 0 ? (
              <div className={`grid gap-6 animate-in fade-in slide-in-from-bottom-4 duration-700 ${viewMode === 'grid' ? 'grid-cols-1 md:grid-cols-2 xl:grid-cols-3' : 'grid-cols-1 max-w-4xl'}`}>
                {results.map((post) => (
                  <PostCard 
                    key={post.id} 
                    post={post} 
                    onSave={saveToCMS}
                    isSaving={savingIds.has(post.id)}
                    isSaved={savedIds.has(post.id)}
                  />
                ))}
              </div>
            ) : !isSearching && (
              <div className="flex flex-col items-center justify-center py-24 text-center animate-in fade-in duration-1000">
                <div className="w-20 h-20 bg-slate-50 dark:bg-slate-900 rounded-full flex items-center justify-center text-slate-200 dark:text-slate-800 mb-6 ring-4 ring-slate-50/50 dark:ring-slate-900/50">
                  <Search size={40} />
                </div>
                <h3 className="text-xl font-bold text-slate-800 dark:text-slate-200">No results to display</h3>
                <p className="text-slate-400 dark:text-slate-500 text-sm max-w-xs mx-auto mt-2">Configure your search parameters in the sidebar and execute your query.</p>
              </div>
            )}
          </main>
        </div>
      </div>
    </div>
  );
}
